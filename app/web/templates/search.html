{% extends "base.html" %}

{% block title %}Search - PDF Scraper{% endblock %}

{% block content %}
<div class="container">
    <h1>Semantic Search</h1>
    <p class="text-muted">Search across all indexed documents using natural language.</p>

    <div class="card mb-4">
        <div class="card-body">
            <div class="setting-row">
                <div style="flex: 4">
                    <input type="text" id="search-query" class="input-field"
                           placeholder="Enter your search query..."
                           autofocus>
                </div>
                <div style="flex: 1">
                    <input type="number" id="search-limit" class="input-field input-small"
                           value="10" min="1" max="50" placeholder="10">
                    <span class="text-muted text-small">results</span>
                </div>
                <button type="button" class="btn btn-primary" id="search-btn"
                        onclick="doSearch()">
                    Search
                </button>
            </div>

            {% if sources %}
            <div class="mt-3">
                <label class="text-muted text-small">Filter by source:</label>
                <div class="setting-row" style="flex-wrap: wrap; gap: 0.5rem;">
                    {% for src in sources %}
                    <label class="checkbox-label">
                        <input type="checkbox" class="source-filter" value="{{ src.source }}" checked>
                        {{ src.source }} ({{ src.chunk_count }})
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="search-results"></div>
</div>

<script>
function doSearch() {
    const query = document.getElementById('search-query').value.trim();
    if (!query) return;

    const limit = parseInt(document.getElementById('search-limit').value) || 10;
    const sourceCheckboxes = document.querySelectorAll('.source-filter:checked');
    const sources = Array.from(sourceCheckboxes).map(cb => cb.value);

    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<p class="text-muted">Searching...</p>';

    fetch('/api/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            query: query,
            sources: sources.length > 0 ? sources : null,
            limit: limit
        })
    })
    .then(r => {
        if (!r.ok) {
            throw new Error('Server returned ' + r.status);
        }
        return r.json();
    })
    .then(data => {
        if (data.error) {
            resultsDiv.innerHTML = '<div class="alert alert-danger">' + escapeHtml(data.error) + '</div>';
            return;
        }

        if (data.count === 0) {
            resultsDiv.innerHTML = '<p class="text-muted">No results found.</p>';
            return;
        }

        let html = '<p class="text-muted mb-3">' + data.count + ' result(s)</p>';
        data.results.forEach(function(r, i) {
            const score = (typeof r.score === 'number' && isFinite(r.score)) ? (r.score * 100).toFixed(1) : '?';
            const meta = r.metadata || {};
            const heading = meta.heading_context ? '<span class="text-muted"> &mdash; ' + escapeHtml(String(meta.heading_context)) + '</span>' : '';
            html += '<div class="card mb-2">';
            html += '<div class="card-body">';
            html += '<div class="setting-row">';
            html += '<strong>' + escapeHtml(r.source || 'unknown') + '/' + escapeHtml(r.filename || 'unknown') + '</strong>';
            html += heading;
            html += '<span class="status-badge status-connected ml-auto">' + score + '% match</span>';
            html += '</div>';
            html += '<p class="mt-2" style="white-space: pre-wrap; font-size: 0.9em;">' + escapeHtml(r.content || '') + '</p>';
            html += '</div></div>';
        });
        resultsDiv.innerHTML = html;
    })
    .catch(function(err) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Search request failed</div>';
    });
}

document.getElementById('search-query').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doSearch();
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
